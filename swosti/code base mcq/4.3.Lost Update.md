## ЁЯФД Lost Update (Transaction Anomaly)

![Image](https://codingsight.com/wp-content/uploads/2017/09/transaction.png)

![Image](https://www.scaler.com/topics/images/lost-update-problem-example.webp)

![Image](https://substackcdn.com/image/fetch/%24s_%21Jb5A%21%2Cf_auto%2Cq_auto%3Agood%2Cfl_progressive%3Asteep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F88e958c3-b538-45a1-aa69-9273d85216a0_4740x3644.png)

### ЁЯФ╣ Lost Update ржХрзА?

**Lost Update** ржШржЯрзЗ ржпржЦржитАФ

> ржжрзБржЗржЯрж╛ concurrent transaction ржПржХржЗ row ржкржбрж╝рзЗ
> ржПржмржВ ржжрзБржЬржирзЗржЗ ржЖрж▓рж╛ржжрж╛ ржХрж░рзЗ update ржХрж░рзЗ,
> ржХрж┐ржирзНрждрзБ **рж╢рзЗрж╖рзЗ ржПржХржЯрж╛рж░ update ржЖрж░рзЗржХржЯрж╛рж░ржЯрж╛ overwrite ржХрж░рзЗ ржлрзЗрж▓рзЗ**ред

ЁЯСЙ ржлрж▓рж╛ржлрж▓: **ржПржХржЯрж┐ update тАЬрж╣рж╛рж░рж┐ржпрж╝рзЗ ржпрж╛ржпрж╝тАЭ (lost)**

---

## ЁЯза Step-by-Step Example

ржзрж░рж┐, ржПржХржЯрж┐ counter ржЯрзЗржмрж┐рж▓:

```sql
id | count
1  | 10
```

### ЁЯз╡ Transaction A

```sql
BEGIN;
SELECT count FROM counter WHERE id = 1;  -- sees 10
-- calculates 10 + 1 = 11
```

### ЁЯз╡ Transaction B

```sql
BEGIN;
SELECT count FROM counter WHERE id = 1;  -- also sees 10
-- calculates 10 + 5 = 15
```

### ЁЯз╡ Transaction A

```sql
UPDATE counter SET count = 11 WHERE id = 1;
COMMIT;
```

### ЁЯз╡ Transaction B

```sql
UPDATE counter SET count = 15 WHERE id = 1;
COMMIT;
```

тЭМ **Final value = 15**
ЁЯСЙ Transaction A-ржПрж░ update **рж╣рж╛рж░рж┐ржпрж╝рзЗ ржЧрзЗрж▓**

---

## ЁЯФТ Isolation Levels & Lost Update

![Image](https://i.sstatic.net/y8ozP.jpg)

![Image](https://vladmihalcea.com/wp-content/uploads/2014/09/uncontendedtransactions1.png)

![Image](https://i.sstatic.net/psrEy.png)

| Isolation Level  | Lost Update Possible?         |
| ---------------- | ----------------------------- |
| READ UNCOMMITTED | тЬЕ                             |
| READ COMMITTED   | тЪая╕П Possible                   |
| REPEATABLE READ  | тЪая╕П Possible (without locking) |
| SERIALIZABLE     | тЭМ No                          |

тЪая╕П PostgreSQL-ржП `REPEATABLE READ` **Lost Update ржкрзБрж░рзЛржкрзБрж░рж┐ ржЖржЯржХрж╛ржпрж╝ ржирж╛**, ржпржжрж┐ explicit lock ржирж╛ ржерж╛ржХрзЗред

---

## ЁЯРШ PostgreSQL-ржП Lost Update ржХрзЗржи рж╣рзЯ?

PostgreSQL:

* Dirty read ржХрж░рзЗ ржирж╛ тЬЕ
* ржХрж┐ржирзНрждрзБ **read тЖТ compute тЖТ write** pattern рж╣рж▓рзЗ
  update conflict рж╣рждрзЗ ржкрж╛рж░рзЗ

ржХрж╛рж░ржг:

* Snapshot isolation
* Automatic row merge ржирж╛ ржХрж░рж╛

---

## тЬЕ How to Prevent Lost Update (PostgreSQL)

### 1я╕ПтГг `SELECT ... FOR UPDATE` (Row Lock)

```sql
BEGIN;
SELECT count FROM counter WHERE id = 1 FOR UPDATE;
UPDATE counter SET count = count + 1 WHERE id = 1;
COMMIT;
```

тЬФя╕П ржЕржирзНржп transaction block рж╣ржмрзЗ
тЬФя╕П Safe

---

### 2я╕ПтГг Atomic UPDATE (Best Practice)

```sql
UPDATE counter
SET count = count + 1
WHERE id = 1;
```

тЬФя╕П No lost update
тЬФя╕П No read needed

---

### 3я╕ПтГг Optimistic Locking (Version Column)

```sql
UPDATE counter
SET count = 11, version = version + 1
WHERE id = 1 AND version = 3;
```

ЁЯСЙ affected rows = 0 тЗТ retry

(Spring Boot/JPA-рждрзЗ `@Version`)

---

### 4я╕ПтГг SERIALIZABLE Isolation

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

тЬФя╕П DB conflict detect ржХрж░ржмрзЗ
тЬФя╕П Transaction abort рж╣ржмрзЗ тЖТ retry needed

---

## ЁЯФБ Lost Update vs Others

| Problem             | What Happens          |
| ------------------- | --------------------- |
| Dirty Read          | Read uncommitted data |
| Lost Update         | Update overwritten    |
| Non-repeatable Read | Same row changes      |
| Phantom Read        | New rows appear       |

---

## ЁЯОп Interview-Ready Answer

> **Lost Update occurs when two concurrent transactions update the same row and one update overwrites the other. PostgreSQL prevents it using row locking (`FOR UPDATE`), atomic updates, optimistic locking, or SERIALIZABLE isolation.**

---

ржпржжрж┐ ржЪрж╛ржУ, ржЖржорж┐ ржкрж░рзЗрж░ ржзрж╛ржкрзЗ ржжрзЗржЦрж╛рждрзЗ ржкрж╛рж░рж┐:

* ЁЯФР `SELECT FOR UPDATE` deep dive
* ЁЯзй JPA `@Version` with real example
* тЪЩя╕П PostgreSQL MVCC conflict internals
* ЁЯЪА High-concurrency safe counter design

ржмрж▓рж▓рзЗржЗ ржмрж▓рзЛ ЁЯСН
