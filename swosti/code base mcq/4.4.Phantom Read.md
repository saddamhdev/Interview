## ЁЯС╗ Phantom Read (Transaction Anomaly)

![Image](https://vladmihalcea.com/wp-content/uploads/2018/06/PhantomRead.png)

![Image](https://mohammaddarab.com/wp-content/uploads/2015/08/Isolation-Levels.png)

![Image](https://sqlnest.wordpress.com/wp-content/uploads/2018/04/isolationlevels.jpg)

### ЁЯФ╣ Phantom Read ржХрзА?

**Phantom Read** ржШржЯрзЗ ржпржЦржитАФ

> ржПржХржЗ transaction-ржПрж░ ржнрзЗрждрж░рзЗ
> **ржПржХржЗ query ржжрзБржЗржмрж╛рж░ ржЪрж╛рж▓рж╛рж▓рзЗ row-ржПрж░ рж╕ржВржЦрзНржпрж╛ ржмржжрж▓рзЗ ржпрж╛ржпрж╝**,
> ржХрж╛рж░ржг ржЕржирзНржп ржПржХржЯрж┐ concurrent transaction **ржирждрзБржи row INSERT/DELETE** ржХрж░рзЗржЫрзЗред

ЁЯСЙ Row-ржЧрзБрж▓рж╛ тАЬржнрзВрждтАЭ (phantom) ржПрж░ ржорждрзЛ **рж╣ржарж╛рзО ржжрзЗржЦрж╛ ржпрж╛ржпрж╝ / рж╣рж╛рж░рж┐ржпрж╝рзЗ ржпрж╛ржпрж╝**ред

---

## ЁЯза Step-by-Step Example

ржзрж░рж┐ `orders` ржЯрзЗржмрж┐рж▓рзЗ `status='PENDING'` ржПржоржи 2ржЯрж╛ row ржЖржЫрзЗред

### ЁЯз╡ Transaction A

```sql
BEGIN;
SELECT COUNT(*) FROM orders WHERE status = 'PENDING';
-- Result: 2
```

### ЁЯз╡ Transaction B

```sql
BEGIN;
INSERT INTO orders(status) VALUES ('PENDING');
COMMIT;
```

### ЁЯз╡ Transaction A (again)

```sql
SELECT COUNT(*) FROM orders WHERE status = 'PENDING';
-- Result: 3  тЭМ (phantom row)
COMMIT;
```

ЁЯСЙ Transaction A ржПржХржЗ query ржЪрж╛рж▓рж┐ржпрж╝рзЗржУ ржнрж┐ржирзНржи ржлрж▓ ржкрзЗрж▓ тЖТ **Phantom Read**

---

## ЁЯФТ Isolation Levels & Phantom Read

![Image](https://vladmihalcea.com/wp-content/uploads/2018/06/PhantomRead.png)

![Image](https://i.sstatic.net/aCtew.png)

![Image](https://mohammaddarab.com/wp-content/uploads/2015/08/Isolation-Levels.png)

| Isolation Level  | Phantom Read Possible? |
| ---------------- | ---------------------- |
| READ UNCOMMITTED | тЬЕ                      |
| READ COMMITTED   | тЬЕ                      |
| REPEATABLE READ  | тЪая╕П (DB-dependent)      |
| SERIALIZABLE     | тЭМ No                   |

---

## ЁЯРШ PostgreSQL-ржП Phantom Read рж╣рзЯ ржХрж┐?

### ЁЯФ╕ READ COMMITTED

тЬЕ **рж╣рзЯ**

ржХрж╛рж░ржг:

* ржкрзНрж░рждрж┐ржЯрж┐ statement ржирждрзБржи snapshot ржжрзЗржЦрзЗ
* ржирждрзБржи INSERT ржХрж░рж╛ row ржжрзЗржЦрж╛ ржпрж╛ржпрж╝

---

### ЁЯФ╕ REPEATABLE READ

тЭМ **ржирж╛** (PostgreSQL-ржП)

PostgreSQL-ржПрж░ `REPEATABLE READ`:

* Transaction рж╢рзБрж░рзБрждрзЗ **ржПржХржЯрж┐ snapshot** ржирзЗржпрж╝
* ржкрж░рзЗ ржирждрзБржи row ржврзБржХрж▓рзЗржУ **ржжрзЗржЦрж╛ ржпрж╛ржпрж╝ ржирж╛**

ЁЯУМ PostgreSQL-specific behavior (ржЕржирзНржпрж╛ржирзНржп DB-рждрзЗ ржнрж┐ржирзНржи рж╣рждрзЗ ржкрж╛рж░рзЗ)

---

### ЁЯФ╕ SERIALIZABLE

тЭМ **ржХржЦржирзЛржЗ ржирж╛**

* Predicate locking ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ
* Phantom ржШржЯрж▓рзЗ transaction abort ржХрж░рзЗ
* Retry ржХрж░рждрзЗ рж╣ржпрж╝

---

## ЁЯФН Phantom Read vs Non-Repeatable Read

| Feature           | Non-Repeatable Read | Phantom Read             |
| ----------------- | ------------------- | ------------------------ |
| Change type       | Existing row UPDATE | New row INSERT/DELETE    |
| Row count changes | тЭМ                   | тЬЕ                        |
| WHERE condition   | Same row            | Same condition, new rows |

---

## ЁЯЫбя╕П How to Prevent Phantom Read

### 1я╕ПтГг SERIALIZABLE (Safest)

```sql
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
```

тЬФя╕П Strongest guarantee
тЪая╕П Conflict рж╣рж▓рзЗ retry ржжрж░ржХрж╛рж░

---

### 2я╕ПтГг Explicit Locking (Advanced)

```sql
SELECT * FROM orders
WHERE status = 'PENDING'
FOR SHARE;
```

тЪая╕П Range-level safety limited
(PostgreSQL-ржП predicate lock SERIALIZABLE-ржП automatically рж╣рзЯ)

---

### 3я╕ПтГг Application-level Design

* Idempotent logic
* Retry on serialization failure
* Avoid тАЬcount-then-insertтАЭ logic

---

## ЁЯОп Interview-Ready One-Liner

> **Phantom Read occurs when a transaction re-executes a query and sees new rows inserted by another transaction. PostgreSQL prevents phantom reads at REPEATABLE READ and SERIALIZABLE levels.**

---

ржЪрж╛ржУ рждрзЛ ржЖржорж┐ ржкрж░рзЗрж░ ржзрж╛ржкрзЗ ржжрзЗржЦрж╛рждрзЗ ржкрж╛рж░рж┐:

* ЁЯРШ PostgreSQL predicate lock internals
* тЪЩя╕П SERIALIZABLE retry pattern (Spring Boot)
* ЁЯФД All anomalies in one comparison table
* ЁЯЪА High-concurrency safe design patterns

ржмрж▓рж▓рзЗржЗ рж╢рзБрж░рзБ ржХрж░рж┐ ЁЯСН
