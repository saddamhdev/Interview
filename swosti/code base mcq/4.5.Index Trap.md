## ЁЯкд Index Trap (Database Performance Pitfall)

![Image](https://substackcdn.com/image/fetch/f_auto%2Cq_auto%3Agood%2Cfl_progressive%3Asteep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F14b745b6-06ff-4c5d-90b1-75943b891dbd_1600x949.png)

![Image](https://pganalyze.com/static/d92dffc7749fada6f63b9488297dee5b/1d69c/nested_loop_vs_hash_join.png)

![Image](https://www.red-gate.com/simple-talk/wp-content/uploads/2024/06/word-image-102795-3.png)

![Image](https://i0.wp.com/www.techmixing.com/wp-content/uploads/2025/11/common-indexing-mistakes-in-sql-server.webp?ssl=1)

### ЁЯФ╣ Index Trap ржХрзА?

**Index Trap** рж╣рж▓рзЛ ржПржоржи ржЕржмрж╕рзНржерж╛ ржпрзЗржЦрж╛ржирзЗтАФ

> ржЯрзЗржмрж┐рж▓рзЗ index ржерж╛ржХрж╛ рж╕рждрзНрждрзНржмрзЗржУ
> query **index ржмрзНржпржмрж╣рж╛рж░ ржирж╛ ржХрж░рзЗ** full table scan ржХрж░рзЗ,
> ржлрж▓рзЗ performance ржЕржкрзНрж░рждрзНржпрж╛рж╢рж┐рждржнрж╛ржмрзЗ **ржЦрж╛рж░рж╛ржк** рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝ред

ЁЯСЙ Dev ржнрж╛ржмрзЗ: *тАЬIndex рждрзЛ ржЖржЫрзЗ!тАЭ*
ЁЯСЙ DB ржнрж╛ржмрзЗ: *тАЬIndex ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ ржЖрж░ржУ slow рж╣ржмрзЗтАЭ*

---

## ЁЯза Common Index Traps (PostgreSQL-centric)

### 1я╕ПтГг Function ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ Index ржХрж╛ржЬ ржХрж░рзЗ ржирж╛

```sql
SELECT * FROM users WHERE LOWER(email) = 'test@example.com';
```

тЭМ `email` index ржерж╛ржХрж▓рзЗржУ ржмрзНржпржмрж╣рж╛рж░ рж╣ржмрзЗ ржирж╛

тЬЕ **Fix**

```sql
CREATE INDEX idx_users_email_lower ON users (LOWER(email));
```

---

### 2я╕ПтГг Data Type Mismatch

```sql
-- age is INTEGER
SELECT * FROM users WHERE age = '25';
```

тЭМ implicit cast тЖТ index ignore

тЬЕ **Fix**

```sql
SELECT * FROM users WHERE age = 25;
```

---

### 3я╕ПтГг Leading Wildcard (`LIKE '%abc'`)

```sql
SELECT * FROM logs WHERE message LIKE '%error';
```

тЭМ B-Tree index useless

тЬЕ **Fix options**

* `LIKE 'error%'`
* `GIN` + `pg_trgm`

```sql
CREATE EXTENSION pg_trgm;
CREATE INDEX idx_logs_msg_trgm ON logs USING gin (message gin_trgm_ops);
```

---

### 4я╕ПтГг Low Selectivity Column

```sql
-- gender has only M/F
SELECT * FROM users WHERE gender = 'M';
```

тЭМ Planner chooses seq scan

ЁЯУМ Index is useless if **most rows match**

---

### 5я╕ПтГг Too Many Rows Returned

```sql
SELECT * FROM orders WHERE status = 'PENDING';
```

If 70тАУ80% rows match тЖТ тЭМ seq scan faster

---

### 6я╕ПтГг Outdated Statistics

```sql
-- data changed a lot
SELECT * FROM big_table WHERE created_at > now() - interval '1 day';
```

тЭМ Planner guess wrong

тЬЕ **Fix**

```sql
ANALYZE big_table;
```

---

### 7я╕ПтГг Wrong Index Order (Composite Index Trap)

```sql
CREATE INDEX idx_orders ON orders (customer_id, status);

SELECT * FROM orders WHERE status = 'PAID';
```

тЭМ index not usable (leftmost rule)

тЬЕ Works only if:

```sql
WHERE customer_id = ?
```

---

## ЁЯФН How to Detect Index Trap

### ЁЯФ╣ Use EXPLAIN (ANALYZE)

```sql
EXPLAIN ANALYZE
SELECT * FROM users WHERE email = 'a@b.com';
```

тЭМ Bad:

```
Seq Scan on users
```

тЬЕ Good:

```
Index Scan using idx_users_email
```

---

## ЁЯЫая╕П How to Avoid Index Traps (Checklist)

| Rule                                | Why                     |
| ----------------------------------- | ----------------------- |
| Avoid functions in WHERE            | Breaks index            |
| Match data types exactly            | Prevents cast           |
| Use correct index type              | B-tree тЙа LIKE           |
| Design composite index carefully    | Leftmost column matters |
| Keep stats fresh                    | Planner accuracy        |
| DonтАЩt index low-cardinality columns | Wasteful                |
| Measure with EXPLAIN ANALYZE        | Always                  |

---

## ЁЯОп Interview-Ready Definition

> **Index Trap is a situation where an index exists but is not used due to query structure, data distribution, or planner decisions, causing unexpected full table scans and poor performance.**

---

## ЁЯФе Real Production Insight (Important)

> **Index тЙа Performance**
> Wrong index or wrong query can be **slower than no index at all**.

---

ржпржжрж┐ ржЪрж╛ржУ, ржЖржорж┐ next step ржП ржжрзЗржЦрж╛рждрзЗ ржкрж╛рж░рж┐:

* ЁЯУК PostgreSQL query planner internals
* ЁЯзй Covering index vs normal index
* ЁЯЪА High-concurrency index strategy
* тЪЩя╕П Spring Boot + JPA index pitfalls

ржмрж▓рж▓рзЗржЗ ржмрж▓рзЛ ЁЯСМ
